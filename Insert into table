-- Insert data into the fact table for game details
INSERT INTO fct_game_details

WITH deduped AS (
    -- Select game details joined with game info and assign a row number to deduplicate
	SELECT 
        gd.*,                     -- all columns from game_details
        g.game_date_est,          -- game date estimated
        g.season,                 -- season of the game
        g.home_team_id,           -- home team id
        ROW_NUMBER() OVER (
            PARTITION BY gd.game_id, gd.team_id, gd.player_id  -- partition to identify duplicates per game/team/player
            ORDER BY g.game_date_est                            -- order by game date to pick the first
        ) AS row_num 
	FROM game_details gd
	JOIN games g
	    ON gd.game_id = g.game_id
	WHERE g.game_date_est = '2016-10-04'                       -- filter for a specific game date
)

SELECT 
    game_date_est AS dim_game_date,    -- alias for fact table dimension date
    season AS dim_season,               -- alias for season dimension
    team_id AS dim_team_id,             -- alias for team dimension
    /* team_id = home_team_id AS dim_is_playing_at_home, */ -- commented out: flag if playing at home
    player_id AS dim_player_id,         -- player dimension id
    player_name AS dim_player_name,     -- player name dimension
    start_position AS dim_start_position, -- starting position dimension
    
    -- Flags for player status inferred from comments
    COALESCE(POSITION('DNP' IN comment), 0) > 0 AS dim_did_not_play,  -- Did Not Play
    COALESCE(POSITION('DND' IN comment), 0) > 0 AS dim_did_not_dress, -- Did Not Dress
    COALESCE(POSITION('NWT' IN comment), 0) > 0 AS dim_not_with_team, -- Not With Team
    
    -- Convert minutes played from "MM:SS" string to decimal hours (minutes + seconds/60)
    CAST(SPLIT_PART(min, ':', 1) AS REAL) + CAST(SPLIT_PART(min, ':', 2) AS REAL)/60 AS m_minutes,
    
    -- Performance metrics mapped directly to measure columns
    fgm AS m_fgm,    -- field goals made
    fga AS m_fga,    -- field goals attempted
    fg3m AS m_fg3m,  -- three point field goals made
    fg3a AS m_fg3a,  -- three point field goals attempted
    fta AS m_fta,    -- free throws attempted
    ftm AS m_ftm,    -- free throws made
    oreb AS m_oreb,  -- offensive rebounds
    dreb AS m_dreb,  -- defensive rebounds
    reb AS m_reb,    -- total rebounds
    ast AS m_ast,    -- assists
    stl AS m_stl,    -- steals
    blk AS m_blk,    -- blocks
    "TO" AS m_turnovers, -- turnovers (quoted because TO is a reserved word)
    pf AS m_pf,      -- personal fouls
    pts AS m_pts,    -- points scored
    plus_minus AS m_plus_minus -- plus-minus metric
FROM deduped
WHERE row_num = 1  -- keep only the first row per game/team/player to remove duplicates
